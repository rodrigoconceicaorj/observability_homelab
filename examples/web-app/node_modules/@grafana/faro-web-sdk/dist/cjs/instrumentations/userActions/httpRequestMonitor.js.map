{"version":3,"file":"httpRequestMonitor.js","sourceRoot":"","sources":["../../../../src/instrumentations/userActions/httpRequestMonitor.ts"],"names":[],"mappings":"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","sourcesContent":["import { genShortID, Observable } from '@grafana/faro-core';\n\nimport { getUrlFromResource, isUrlIgnored } from '../../utils/url';\n\nimport { MESSAGE_TYPE_HTTP_REQUEST_END, MESSAGE_TYPE_HTTP_REQUEST_START } from './const';\nimport type { HttpRequestEndMessage, HttpRequestMessagePayload, HttpRequestStartMessage } from './types';\n\ntype RequestProps = HttpRequestMessagePayload;\n\nconst apiTypeFetch = 'fetch';\nconst apiTypeXhr = 'xhr';\n\n/**\n * Monitors if any http requests are in progress.\n */\nexport function monitorHttpRequests(): Observable<HttpRequestStartMessage | HttpRequestEndMessage> {\n  const observable = new Observable<HttpRequestStartMessage | HttpRequestEndMessage>();\n\n  function emitStartMessage(requestProps: RequestProps) {\n    observable.notify({\n      type: MESSAGE_TYPE_HTTP_REQUEST_START,\n      request: requestProps,\n    });\n  }\n\n  function emitEndMessage(requestProps: RequestProps) {\n    observable.notify({\n      type: MESSAGE_TYPE_HTTP_REQUEST_END,\n      request: requestProps,\n    });\n  }\n\n  monitorFetch({\n    onRequestStart: emitStartMessage,\n    onRequestEnd: emitEndMessage,\n  });\n\n  monitorXhr({\n    onRequestStart: emitStartMessage,\n    onRequestEnd: emitEndMessage,\n  });\n\n  return observable;\n}\n\nfunction monitorXhr({\n  onRequestStart,\n  onRequestEnd,\n}: {\n  onRequestStart: (props: RequestProps) => void;\n  onRequestEnd: (props: RequestProps) => void;\n}) {\n  const originalOpen = XMLHttpRequest.prototype.open;\n\n  XMLHttpRequest.prototype.open = function () {\n    const url = arguments[1];\n    const isIgnoredUrl = isUrlIgnored(url);\n    const method = arguments[0];\n\n    const requestId = genShortID();\n\n    // request has started to load data.\n    this.addEventListener('loadstart', function () {\n      if (!isIgnoredUrl) {\n        onRequestStart({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    // transaction completes successfully.\n    this.addEventListener('load', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    this.addEventListener('error', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    this.addEventListener('abort', function () {\n      if (!isIgnoredUrl) {\n        onRequestEnd({ url, method, requestId, apiType: apiTypeXhr });\n      }\n    });\n\n    originalOpen.apply(this, arguments as any);\n  };\n}\n\nfunction monitorFetch({\n  onRequestEnd,\n  onRequestStart,\n}: {\n  onRequestStart: (props: RequestProps) => void;\n  onRequestEnd: (props: RequestProps) => void;\n}) {\n  const originalFetch = window.fetch;\n\n  window.fetch = function () {\n    const url = getUrlFromResource(arguments[0]) ?? '';\n    const isIgnoredUrl = isUrlIgnored(url);\n    const method = (arguments[1] ?? {}).method;\n\n    const requestId = genShortID();\n\n    if (!isIgnoredUrl) {\n      onRequestStart({ url, method, requestId, apiType: apiTypeFetch });\n    }\n\n    return originalFetch\n      .apply(this, arguments as any)\n      .then((response) => {\n        if (!isIgnoredUrl) {\n          onRequestEnd({ url, method, requestId, apiType: apiTypeFetch });\n        }\n        return response;\n      })\n      .catch((error) => {\n        if (!isIgnoredUrl) {\n          onRequestEnd({ url, method, requestId, apiType: apiTypeFetch });\n        }\n        throw error;\n      });\n  };\n}\n"]}