{"version":3,"file":"performanceUtils.js","sourceRoot":"","sources":["../../../../src/instrumentations/performance/performanceUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import { isArray, type PushEventOptions, unknownString } from '@grafana/faro-core';\n\nimport type { CacheType, FaroNavigationTiming, FaroResourceTiming } from './types';\n\nconst w3cTraceparentFormat = /^00-[a-f0-9]{32}-[a-f0-9]{16}-[0-9]{1,2}$/;\n\ntype SpanContext = PushEventOptions['spanContext'];\n\n// Extract traceparent from serverTiming, if present\nexport function getSpanContextFromServerTiming(serverTimings: PerformanceServerTiming[] = []): SpanContext | undefined {\n  for (const serverEntry of serverTimings) {\n    if (serverEntry.name === 'traceparent') {\n      if (!w3cTraceparentFormat.test(serverEntry.description)) {\n        continue;\n      }\n\n      const [, traceId, spanId] = serverEntry.description.split('-');\n      if (traceId != null && spanId != null) {\n        return { traceId, spanId };\n      }\n\n      break;\n    }\n  }\n\n  return undefined;\n}\n\nexport function performanceObserverSupported(): boolean {\n  return 'PerformanceObserver' in window;\n}\n\nexport function onDocumentReady(handleReady: () => void) {\n  if (document.readyState === 'complete') {\n    handleReady();\n  } else {\n    const readyStateCompleteHandler = () => {\n      if (document.readyState === 'complete') {\n        handleReady();\n        document.removeEventListener('readystatechange', readyStateCompleteHandler);\n      }\n    };\n\n    document.addEventListener('readystatechange', readyStateCompleteHandler);\n  }\n}\n\ntype PerformanceEntryAllowProperties = Record<string, Array<string | number> | string | number>;\n\nexport function includePerformanceEntry(\n  performanceEntryJSON: Record<string, any>,\n  allowProps: PerformanceEntryAllowProperties = {}\n): boolean {\n  for (const [allowPropKey, allowPropValue] of Object.entries(allowProps)) {\n    const perfEntryPropVal = performanceEntryJSON[allowPropKey];\n\n    if (perfEntryPropVal == null) {\n      return false;\n    }\n\n    if (isArray(allowPropValue)) {\n      return allowPropValue.includes(perfEntryPropVal);\n    }\n\n    return perfEntryPropVal === allowPropValue;\n  }\n\n  // empty object allows all\n  return true;\n}\n\nexport function createFaroResourceTiming(resourceEntryRaw: PerformanceResourceTiming): FaroResourceTiming {\n  const {\n    connectEnd,\n    connectStart,\n    decodedBodySize,\n    domainLookupEnd,\n    domainLookupStart,\n    duration,\n    encodedBodySize,\n    fetchStart,\n    initiatorType,\n    name,\n    nextHopProtocol,\n    redirectEnd,\n    redirectStart,\n    // @ts-expect-error the renderBlockingStatus property is not available in all browsers\n    renderBlockingStatus: rbs,\n    requestStart,\n    responseEnd,\n    responseStart,\n    responseStatus,\n    secureConnectionStart,\n    transferSize,\n    workerStart,\n  } = resourceEntryRaw;\n\n  return {\n    name: name,\n    duration: toFaroPerformanceTimingString(duration),\n    tcpHandshakeTime: toFaroPerformanceTimingString(connectEnd - connectStart),\n    dnsLookupTime: toFaroPerformanceTimingString(domainLookupEnd - domainLookupStart),\n    tlsNegotiationTime: toFaroPerformanceTimingString(connectEnd - secureConnectionStart),\n    responseStatus: toFaroPerformanceTimingString(responseStatus),\n    redirectTime: toFaroPerformanceTimingString(redirectEnd - redirectStart),\n    requestTime: toFaroPerformanceTimingString(responseStart - requestStart),\n    responseTime: toFaroPerformanceTimingString(responseEnd - responseStart),\n    fetchTime: toFaroPerformanceTimingString(responseEnd - fetchStart),\n    serviceWorkerTime: toFaroPerformanceTimingString(fetchStart - workerStart),\n    decodedBodySize: toFaroPerformanceTimingString(decodedBodySize),\n    encodedBodySize: toFaroPerformanceTimingString(encodedBodySize),\n    cacheHitStatus: getCacheType(),\n    renderBlockingStatus: toFaroPerformanceTimingString(rbs) as FaroResourceTiming['renderBlockingStatus'],\n    protocol: nextHopProtocol,\n    initiatorType: initiatorType,\n    visibilityState: document.visibilityState,\n    ttfb: toFaroPerformanceTimingString(responseStart - requestStart),\n    transferSize: toFaroPerformanceTimingString(transferSize),\n\n    // TODO: add in future iteration, ideally after nested objects are supported by the collector.\n    // serverTiming: resourceEntryRaw.serverTiming,\n  };\n\n  function getCacheType(): CacheType {\n    let cacheType: CacheType = 'fullLoad';\n    if (transferSize === 0) {\n      if (decodedBodySize > 0) {\n        cacheType = 'cache';\n      }\n    } else {\n      if (responseStatus != null) {\n        if (responseStatus === 304) {\n          cacheType = 'conditionalFetch';\n        }\n      } else if (encodedBodySize > 0 && transferSize < encodedBodySize) {\n        cacheType = 'conditionalFetch';\n      }\n    }\n    return cacheType;\n  }\n}\n\nexport function createFaroNavigationTiming(navigationEntryRaw: PerformanceNavigationTiming): FaroNavigationTiming {\n  const {\n    activationStart,\n    domComplete,\n    domContentLoadedEventEnd,\n    domContentLoadedEventStart,\n    domInteractive,\n    fetchStart,\n    loadEventEnd,\n    loadEventStart,\n    responseStart,\n    type,\n  } = navigationEntryRaw;\n\n  const parserStart = getDocumentParsingTime();\n\n  return {\n    ...createFaroResourceTiming(navigationEntryRaw),\n    pageLoadTime: toFaroPerformanceTimingString(domComplete - fetchStart),\n    documentParsingTime: toFaroPerformanceTimingString(parserStart ? domInteractive - parserStart : null),\n    domProcessingTime: toFaroPerformanceTimingString(domComplete - domInteractive),\n    domContentLoadHandlerTime: toFaroPerformanceTimingString(domContentLoadedEventEnd - domContentLoadedEventStart),\n    onLoadTime: toFaroPerformanceTimingString(loadEventEnd - loadEventStart),\n\n    // For navigation entries we can calculate the TTFB based on activationStart. We overwrite the TTFB value coming with the resource entry.\n    // For more accuracy on prerendered pages page we calculate relative top the activationStart instead of the start of the navigation.\n    // clamp to 0 if activationStart occurs after first byte is received.\n    ttfb: toFaroPerformanceTimingString(Math.max(responseStart - (activationStart ?? 0), 0)),\n    type: type,\n  };\n}\n\nfunction getDocumentParsingTime(): number | null {\n  if (performance.timing?.domLoading != null) {\n    // the browser is about to start parsing the first received bytes of the HTML document.\n    // This property is deprecated but there isn't a really good alternative atm.\n    // For now we stick with domLoading and keep researching a better alternative.\n    return performance.timing.domLoading - performance.timeOrigin;\n  }\n\n  return null;\n}\n\nfunction toFaroPerformanceTimingString(v: unknown): string {\n  if (v == null) {\n    return unknownString;\n  }\n\n  if (typeof v === 'number') {\n    return Math.round(v > 0 ? v : 0).toString();\n  }\n\n  return v.toString();\n}\n"]}