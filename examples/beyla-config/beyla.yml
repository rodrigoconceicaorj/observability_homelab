# Grafana Beyla Configuration
# Coleta automática de métricas RED (Rate, Errors, Duration) sem instrumentação manual

# Configuração de descoberta de serviços
discovery:
  services:
    # Descoberta automática por porta
    - port: 3000
      name: "web-app"
      namespace: "poc-porto"
    - port: 8080
      name: "api-service"
      namespace: "poc-porto"
    # Descoberta por processo
    - exe_path: "node"
      name: "node-app"
      namespace: "poc-porto"
    # Descoberta por container
    - k8s_namespace: "default"
      k8s_pod_name: ".*web.*"
      name: "k8s-web"
      namespace: "poc-porto"

# Configuração de instrumentação
instrumentation:
  # Instrumentação HTTP
  http:
    enabled: true
    # Captura headers específicos
    capture_headers:
      - "user-agent"
      - "content-type"
      - "authorization"
    # Filtros de URL
    url_patterns:
      ignore:
        - "/health"
        - "/metrics"
        - "/favicon.ico"
        - ".*\.css"
        - ".*\.js"
        - ".*\.png"
        - ".*\.jpg"
        - ".*\.gif"
  
  # Instrumentação gRPC
  grpc:
    enabled: true
  
  # Instrumentação de banco de dados
  database:
    enabled: true
    # Captura queries SQL (cuidado com dados sensíveis)
    capture_sql: false

# Configuração de métricas
metrics:
  # Métricas RED básicas
  red:
    enabled: true
    # Rate: requests per second
    rate:
      enabled: true
      buckets: [0.1, 0.5, 1, 2, 5, 10, 30, 60]
    # Errors: error rate
    errors:
      enabled: true
      # Códigos HTTP considerados como erro
      http_codes: [400, 401, 403, 404, 500, 502, 503, 504]
    # Duration: response time
    duration:
      enabled: true
      # Buckets para histograma de latência (em segundos)
      buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
  
  # Métricas customizadas
  custom:
    enabled: true
    # Métricas de throughput
    throughput:
      enabled: true
    # Métricas de concorrência
    concurrency:
      enabled: true

# Configuração de traces
traces:
  enabled: true
  # Sampling rate (0.0 a 1.0)
  sampling_rate: 0.1
  # Configuração de spans
  spans:
    # Máximo de spans por trace
    max_spans: 1000
    # Timeout para spans
    timeout: "30s"

# Configuração de logs
logs:
  enabled: true
  # Nível de log
  level: "info"
  # Formato de log
  format: "json"
  # Captura de logs da aplicação
  application_logs:
    enabled: false  # Desabilitado por padrão para evitar overhead

# Configuração de exportação
export:
  # Exportação para Grafana Alloy
  otlp:
    endpoint: "http://alloy:4317"
    # Configuração de retry
    retry:
      enabled: true
      max_attempts: 3
      backoff: "exponential"
    # Configuração de batch
    batch:
      size: 512
      timeout: "5s"
  
  # Exportação para Prometheus (opcional)
  prometheus:
    enabled: false
    endpoint: "/metrics"
    port: 9090
  
  # Exportação para Jaeger (opcional)
  jaeger:
    enabled: false
    endpoint: "http://jaeger:14268/api/traces"

# Configuração de recursos
resources:
  # Atributos de recurso
  attributes:
    service.name: "beyla-collector"
    service.version: "1.0.0"
    deployment.environment: "poc"
    team: "observability"

# Configuração de performance
performance:
  # Configuração de CPU
  cpu:
    # Limite de CPU (em cores)
    limit: 0.5
  # Configuração de memória
  memory:
    # Limite de memória (em MB)
    limit: 256
  # Configuração de rede
  network:
    # Buffer size para captura de pacotes
    buffer_size: 1024

# Configuração de segurança
security:
  # Configuração de TLS
  tls:
    enabled: false
    cert_file: "/etc/ssl/certs/beyla.crt"
    key_file: "/etc/ssl/private/beyla.key"
  # Configuração de autenticação
  auth:
    enabled: false
    token: "${BEYLA_AUTH_TOKEN}"

# Configuração de debug
debug:
  enabled: false
  # Porta para debug
  port: 8081
  # Métricas internas do Beyla
  internal_metrics: true